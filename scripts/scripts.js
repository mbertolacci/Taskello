"use strict";angular.module("TrelloTasksApp",["ui.bootstrap"]).config(["$routeProvider",function(t){t.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),function(){angular.module("TrelloTasksApp").directive("fillParentHeight",["$timeout",function(t){return function(n,e){var r;return r=function(){var t,n,r;return r=e.parent().offset(),t=e.offset(),n=e.parent().height(),e.css({"max-height":n-(t.top-r.top)})},e.parent().on("resized",r),t(r)}}]),angular.module("TrelloTasksApp").directive("fillWindowHeight",["$timeout",function(t){return function(n,e){var r;return r=function(){var t,n,r;return n=e.offset(),r=$(window).height(),t=parseInt(e.css("marginBottom")),e.css({height:r-n.top-t}),e.trigger("resized")},$(window).on("resize",r),t(r)}}]),angular.module("TrelloTasksApp").controller("MainCtrl",["$scope","$q","Trello","TrelloTasks",function(t,n,e,r){return t.trelloTasks=r,t.isBoardCollapsed=!1,t.isOrganizationCollapsed=!0,t.organizations=e.organizations,t.lists=e.lists,t.boards=e.boards,t.organizationHasCards=function(t){return _.any(t.boards,function(t){var n;return null!=t?null!=(n=t.cards)?n.length:void 0:void 0})},t.boardHasCards=function(t){var n;return null!=t?null!=(n=t.cards)?n.length:void 0:void 0}}])}.call(this),function(){angular.module("TrelloTasksApp").directive("sortable",[function(){return{require:"?ngModel",link:function(t,n,e,r){var a,o;return o=angular.extend({},t.$eval(e.sortable)),r.$render=function(){return n.sortable("refresh")},a=!1,n.sortable(o).on("sortstart",function(t,n){var e;return n.item.model||(e=$(n.helper).data("model"),e&&(n.item.model=e,n.item.fromElsewhere=!0)),n.item.model?void 0:n.item.model=r.$modelValue[n.item.index()]}).on("sortstop",function(n,e){var a,o,i;if(i=$(e.item).data("dropped"),e.item.model)if(a=_.indexOf(r.$modelValue,e.item.model),o=e.item.index(),i)r.$modelValue.splice(a,1);else{if(a===o)return;-1!==a&&r.$modelValue.splice(a,1),r.$modelValue.splice(o,0,e.item.model)}return $(e.item).remove(),t.$apply()})}}}]),angular.module("TrelloTasksApp").directive("draggable",[function(){return{require:"?ngModel",link:function(t,n,e,r){var a;return a=angular.extend({},t.$eval(e.draggable)),n.draggable(a).on("dragstart",function(t,n){return $(n.helper).data("model",r.$modelValue)})}}}]),angular.module("TrelloTasksApp").directive("droppable",[function(){return{link:function(t,n,e){var r;return r=angular.extend({},t.$eval(e.droppable)),n.droppable(r).on("drop",function(t,n){return $(n.draggable).data("dropped",!0)})}}}])}.call(this),function(){var t;angular.module("TrelloTasksApp").factory("Tasks",["$window","$rootScope","$timeout","$q","makeEventEmitter",function(n,e,r,a,o){var i,u,l,s,c,d,g;return c=o({}),l=a.defer(),d=a.defer(),c.user=null,c.authenticationState="unknown",c.lastAuthenticationError={},u=new Firebase("https://trellotasks.firebaseio.com/users"),i=new FirebaseAuthClient(u,function(t,n){return n?(c.user=n,c.authenticationState="authenticated",angular.copy({},c.lastAuthenticationError),c.trigger("authenticated")):(c.user=null,c.authenticationState="unauthenticated",angular.copy(t,c.lastAuthenticationError),c.trigger("unauthenticated",t))}),s=null,g=null,c.on("authenticated",function(){var n,r;return s||(n=u.child(""+c.user.id+"/tasks"),s=t(n,l,e),r=u.child(""+c.user.id+"/trelloAccount"),g=t(r,d,e,{})),s.watch(),g.watch()}),c.on("unauthenticated",function(){return null!=s&&s.stopWatching(),null!=g?g.stopWatching():void 0}),c.getTaskCards=function(){return l.promise},c.getTrelloToken=function(){return d.promise.then(function(t){return t.apiToken})},c.setTrelloToken=function(t){return d.promise.then(function(n){return n.apiToken=t})},c.logout=function(){return s.stopWatching(),i.logout()},c.login=function(t){return i.login("password",{email:t.email,password:t.password})},c.createUser=function(t){var n;return n=a.defer(),i.createUser(t.email,t.password,function(r){return r?(n.reject(),e.$apply(function(){return angular.copy(r,c.lastAuthenticationError)})):(c.login(t),n.resolve())}),n.promise},c}]),angular.module("TrelloTasksApp").factory("TrelloTasks",["$timeout","$rootScope","makeEventEmitter","Trello","Tasks",function(t,n,e,r,a){var o,i;return o=e({}),o.authenticationState="unknown",o.lastAuthenticationError=a.lastAuthenticationError,i=function(){return o.user=a.user,o.authenticationState="unknown"===a.authenticationState?"unknown":"authenticated"!==a.authenticationState?o.authenticating?"authenticating":"unauthenticated":r.authorized?"authenticated":o.authenticating?"authenticating":"needTrello"},r.on("unauthenticated",i),a.on("unauthenticated",i),r.on("authenticated",function(){return a.setTrelloToken(r.getApiToken()),i()}),a.on("authenticated",function(){return o.authenticating=!0,a.getTrelloToken().then(function(t){return t?(o.authenticating=!0,r.authorize(t).then(function(){return o.authenticating=!1},function(){return o.authenticating=!1})):o.authenticating=!1,i()}),i()}),i(),o.taskCards=a.getTaskCards(),r.on("cards-updated",function(t){return o.taskCards.then(function(n){var e,r;return e={},_.each(t,function(t){var r;return r=_.findWhere(n,{id:t.id}),r?(angular.copy(t,r),e[r.id]=!0):void 0}),r=_.filter(n,function(t){return e[t.id]}),angular.copy(r,n)})}),o.createUser=function(t,n){return o.creatingUser=!0,a.createUser({email:t,password:n}).then(function(){return o.creatingUser=!1},function(){return o.creatingUser=!1})},o.signIn=function(t,n){return o.authenticating=!0,a.login({email:t,password:n})},o.signOut=function(){return a.logout()},o.connectTrello=function(){return r.authorize()},o}]),t=function(t,n,e,r){var a,o,i,u,l;return null==r&&(r=[]),l=!1,u=null,a=!0,o=null,i=function(t){return u||(u=r,n.resolve(u)),t.val()&&angular.copy(t.val(),u),o=angular.copy(u)},t.on("value",function(t){return"$apply"===e.$$phase||"$digest"===e.$$phase?i(t):e.$apply(function(){return i(t)})}),e.$watch(function(){var n;return a?(a=!1,void 0):l?(n=JSON.parse(angular.toJson(u)),angular.equals(o,n)?void 0:t.set(n)):void 0}),{watch:function(){return l=!0},stopWatching:function(){return l=!1}}}}.call(this),function(){var t=[].slice;angular.module("TrelloTasksApp").factory("makeEventEmitter",["$rootScope","$timeout",function(n,e){return function(n){var r;return r={},n.on=function(t,n){var e;return null==(e=r[t])&&(r[t]=[]),r[t].push(n)},n.trigger=function(){var n,a;return a=arguments[0],n=arguments.length>=2?t.call(arguments,1):[],angular.forEach(r[a]||[],function(t){return e(function(){return t.apply(null,n)})})},n}}]),angular.module("TrelloTasksApp").factory("Trello",["$rootScope","$timeout","$q","makeEventEmitter",function(t,n,e,r){var a,o;return o=r({}),o.authorized=!1,a=function(n,r){var a;return null==r&&(r={}),a=e.defer(),Trello.get(n,r,function(n){return t.$apply(function(){return a.resolve(n)})},function(n){return t.$apply(function(){return a.reject(n)})}),a.promise},o.authorize=function(t){var r;return t&&Trello.setToken(t),r=e.defer(),Trello.authorize({name:"Taskello",type:"popup",interactive:!t,persist:!1,success:function(){return n(function(){return o.authorized=!0,o.trigger("authenticated"),r.resolve(!0)})},error:function(){return n(function(){return o.trigger("unauthenticated"),r.reject(!0)})}}),r.promise},o.getApiToken=function(){return Trello.token()},o.organizations={my:{displayName:"My Boards"}},o.boards={},o.lists={},o.cards={},o.on("authenticated",function(){return e.all([a("member/me/boards",{lists:"open"}),a("member/me/organizations")]).then(function(t){var n,r;return n=t[0],r=t[1],_.each(r,function(t){return o.organizations[t.id]=t}),e.all(_.map(n,function(t){var n,e;return t.idOrganization&&o.organizations[t.idOrganization]||(t.idOrganization="my"),null==(e=(n=o.organizations[t.idOrganization]).boards)&&(n.boards=[]),o.organizations[t.idOrganization].boards.push(t),o.boards[t.id]=t,_.each(t.lists,function(t){return o.lists[t.id]=t}),a("board/"+t.id+"/cards").then(function(n){return t.cards=n,_.each(n,function(t){var n,e;return null==(e=(n=o.lists[t.idList]).cards)&&(n.cards=[]),o.lists[t.idList].cards.push(t),o.cards[t.id]=t})})}))}).then(function(){return o.trigger("cards-updated",o.cards),o.trigger("lists-updated",o.lists),o.trigger("boards-updated",o.boards),o.trigger("organizations-updated",o.organizations)})}),o}])}.call(this);