"use strict";angular.module("TrelloTasksApp",["ui.bootstrap","serviceScope"]).config(["$routeProvider",function(t){t.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),function(){angular.module("TrelloTasksApp").directive("fillParentHeight",["$timeout",function(){return function(t,n){var e;return e=function(){var t,e,r;return r=n.parent().offset(),t=n.offset(),e=n.parent().height(),n.css({"max-height":e-(t.top-r.top)})},n.parent().on("resized",e),setTimeout(e)}}]),angular.module("TrelloTasksApp").directive("fillWindowHeight",["$timeout",function(){return function(t,n){var e,r;return e=function(){var t,e,r;return e=n.offset(),r=$(window).height(),t=parseInt(n.css("marginBottom")),n.css({height:r-e.top-t}),n.trigger("resized")},r=function(){return e(),setTimeout(r,1e3)},r(),$(window).on("resize",e)}}]),angular.module("TrelloTasksApp").directive("throttledModel",[function(){return function(t,n,e){var r;return r=_.debounce(function(n){return t.$apply(function(){return t[e.throttledModel]=n})},50),n.on("input",function(){return r(n.val())})}}]),angular.module("TrelloTasksApp").controller("MainCtrl",["$scope","$q","Trello","TrelloTasks",function(t,n,e,r){var a,u;return t.trelloTasks=r,t.isBoardCollapsed=!1,t.isOrganizationCollapsed=!1,t.$name="main",t.trello=e.$attach(t,"trello"),t.organizationHasMatchingCards=function(n,e){return _.any(n.boards,function(n){return t.boardHasMatchingCards(n,e)})},a=function(t,n){var r;return n.justMe&&-1===_.indexOf(t.idMembers,e.me.id)?!1:(r=n.searchTerms,r&&""!==r&&r.split?_.every(_.toArray(r.split(/\ /g)),function(n){var r,a;return a=RegExp(""+n,"i"),t.name.match(a)?!0:e.lists[t.idList].name.match(a)?!0:e.boards[t.idBoard].name.match(a)?!0:(r=e.boards[t.idBoard].idOrganization||"my",e.organizations[r].displayName.match(a)?!0:!1)}):!0)},u=function(t,n){return _.any(t,function(t){return a(t,n)})},t.boardHasMatchingCards=function(t,n){return u(t.cards,n)},t.listHasMatchingCards=function(t,n){return u(t.cards,n)},t.cardMatches=a}])}.call(this),function(){angular.module("TrelloTasksApp").directive("sortable",[function(){return{require:"?ngModel",link:function(t,n,e,r){var a,u;return u=angular.extend({},t.$eval(e.sortable)),r.$render=function(){return n.sortable("refresh")},a=!1,n.sortable(u).on("sortstart",function(t,n){var e;return n.item.model||(e=$(n.helper).data("model"),e&&(n.item.model=e,n.item.fromElsewhere=!0)),n.item.model?void 0:n.item.model=r.$modelValue[n.item.index()]}).on("sortstop",function(n,e){var a,u,o;if(o=$(e.item).data("dropped"),e.item.model)if(a=_.indexOf(r.$modelValue,e.item.model),u=e.item.index(),o)r.$modelValue.splice(a,1);else{if(a===u)return;-1!==a&&r.$modelValue.splice(a,1),r.$modelValue.splice(u,0,e.item.model)}return $(e.item).remove(),t.$apply()})}}}]),angular.module("TrelloTasksApp").directive("draggable",[function(){return{require:"?ngModel",link:function(t,n,e,r){var a;return a=angular.extend({},t.$eval(e.draggable)),n.draggable(a).on("dragstart",function(t,n){return $(n.helper).data("model",r.$modelValue)})}}}]),angular.module("TrelloTasksApp").directive("droppable",[function(){return{link:function(t,n,e){var r;return r=angular.extend({},t.$eval(e.droppable)),n.droppable(r).on("drop",function(t,n){return $(n.draggable).data("dropped",!0)})}}}])}.call(this),function(){var t,n=[].slice;t=function(t){return setTimeout(t,0)},angular.module("TrelloTasksApp").factory("angularBurn",["$q","$serviceScope",function(e,r){var a,u,o;return a=function(a){var u,o;return u=r(),o=new FirebaseAuthClient(a,function(n,e){return t(function(){return u.$apply(function(){return e?u.$emit("authenticated",e):u.$emit("unauthenticated",n)})})}),u.login=function(){var t;return t=arguments.length>=1?n.call(arguments,0):[],o.login.apply(o,t)},u.logout=function(){var t;return t=arguments.length>=1?n.call(arguments,0):[],o.logout.apply(o,t)},u.createUser=function(){var t,r;return t=arguments.length>=1?n.call(arguments,0):[],r=e.defer(),o.createUser.apply(o,n.call(t).concat([function(t,n){return t?r.reject(t):r.resolve(n)}])),r.promise},u},u=function(t,n){var e,o,i,c,l,s,d,f;return null==n&&(n=[]),o=r(),f=o.$defer("value"),i=null,e=function(t){return setTimeout(function(){return o.$apply(t)},0)},d=function(t){return o.value||(o.value=angular.copy(n),f.resolve(o.value)),angular.copy(t.val(),o.value),i=angular.copy(o.value)},c=null,l=function(){var n;return t.on("value",function(t){return e(function(){return d(t)})}),n=!0,c=o.$watch(function(){var e;return n?(n=!1,void 0):_.isUndefined(o.value)?void 0:(e=JSON.parse(angular.toJson(o.value)),angular.equals(i,e)?void 0:t.set(e))})},s=function(){return"function"==typeof c&&c(),t.off("value")},angular.extend(o,{_reference:t,authClient:function(){return a(t)},child:function(n,e){var r;return r=t.child(n),u(r,e)},watch:l,stopWatching:s}),o},o={},o.client=function(t,n){var e;return e=new Firebase(t),u(e,n)},o}])}.call(this),function(){var t,n,e,r,a=[].slice;t=function(t){var n;return n=null,function(){var e,r;return e=arguments.length>=1?a.call(arguments,0):[],r=this,clearTimeout(n),n=setTimeout(function(){return n=null,t.call.apply(t,[r].concat(a.call(e)))},0),null}},e=function(t,n){return t===n?n:angular.isArray(t)||angular.isObject(t)?angular.isUndefined(n)?t:(angular.forEach(t,function(t,r){return"$"!==("function"==typeof r.charAt?r.charAt(0):void 0)?angular.isObject(t)&&angular.isObject(n[r])||angular.isArray(t)&&angular.isArray(n[r])?e(t,n[r]):n[r]!==t?n[r]=t:void 0:void 0}),angular.isArray(n)&&angular.isArray(t)?n.length=t.length:angular.forEach(n,function(e,r){return"$"!==("function"==typeof r.charAt?r.charAt(0):void 0)?angular.isUndefined(t[r])?delete n[r]:void 0:void 0}),n):t},n=function(n){return null==n.$$digestOnceOnNextTick&&(n.$$digestOnceOnNextTick=t(function(){return n.$digest()})),n.$$digestOnceOnNextTick()},angular.module("serviceScope",[]).factory("$compose",[function(){var t;return t={compose:function(e,r,a){var u,o,i;return o=r.$watch(a,function(t,e){if(t!==e)throw Error("$dstScope was detached from scope");return n(r)}),u=r.$watch(function(){return n(r)}),i=function(){return o(),u()},e.$on("$destroy",i),r.$on("$destroy",i),r[a]=r,t},composeProperty:function(r,a,u,o){var i,c,l;return c=u.$watch(o,function(){return r[a]=e(u[o],r[a]),n(r)}),i=r.$watch(a,function(){return u[o]=e(r[a],u[o]),n(u)}),l=function(){return c(),i()},r.$on("$destroy",l),u.$on("$destroy",l),u[o]=r[a],t}}}]),angular.module("serviceScope").factory("$serviceScope",["$rootScope","$cleanQ","$compose",function(t,r,a){return function(){var u,o;return u=t.$new(!0),o={},u.$get=function(t){return o[t].then(function(){return u[t]})},u.$defer=function(t){var e;return e=r.defer(),o[t]=e.promise.then(function(e){return u[t]=e,n(u)}),e},u.$update=function(t,n){return u[t]=e(n,u[t])},u.$attachProperty=function(t){return{to:function(n,e){return a.composeProperty(u,t,n,e),null}}},u.$attach=function(t,n){return a.compose(u,t,n),u},u}}]),angular.module("serviceScope").factory("$cleanQ",["$exceptionHandler",function(t){return r(function(t){return setTimeout(t,0)},t)}]),r=function(t,n){var e,r,a,u,o,i,c;return r=function(t){return t},a=function(t){return i(t)},e=function(t){var n,e,r;return e=u(),n=t.length,r=[],n?angular.forEach(t,function(t,a){return o(t).then(function(t){return a in r?void 0:(r[a]=t,--n?void 0:e.resolve(r))},function(t){return a in r?void 0:e.reject(t)})}):e.resolve(r),e.promise},u=function(){var e,c,l;return c=[],l=void 0,e=void 0,e={resolve:function(n){var e;return c&&(e=c,c=void 0,l=o(n),e.length)?t(function(){var t,n,r,a;for(t=void 0,n=0,r=e.length,a=[];r>n;)t=e[n],l.then(t[0],t[1]),a.push(n++);return a}):void 0},reject:function(t){return e.resolve(i(t))},promise:{then:function(t,e){var o,i,s;return o=u(),i=function(e){try{return o.resolve((t||r)(e))}catch(a){return n(a),o.reject(a)}},s=function(t){try{return o.resolve((e||a)(t))}catch(r){return n(r),o.reject(r)}},c?c.push([i,s]):l.then(i,s),o.promise}}}},o=function(n){return n&&n.then?n:{then:function(e){var r;return r=u(),t(function(){return r.resolve(e(n))}),r.promise}}},i=function(n){return{then:function(e,r){var o;return o=u(),t(function(){return o.resolve((r||a)(n))}),o.promise}}},c=function(e,c,l){var s,d,f,h;return d=u(),s=void 0,f=function(t){try{return(c||r)(t)}catch(e){return n(e),i(e)}},h=function(t){try{return(l||a)(t)}catch(e){return n(e),i(e)}},t(function(){return o(e).then(function(t){return s?void 0:(s=!0,d.resolve(o(t).then(f,h)))},function(t){return s?void 0:(s=!0,d.resolve(h(t)))})}),d.promise},{defer:u,reject:i,when:c,all:e}}}.call(this),function(){angular.module("TrelloTasksApp").factory("Tasks",["$window","$rootScope","$timeout","$q","$serviceScope","angularBurn",function(t,n,e,r,a,u){var o,i,c,l,s,d,f;return o=a(),o.user=null,o.authenticationState="unknown",o.lastAuthenticationError={},o.taskCards=null,o.trelloApiToken=null,f=u.client("https://trellotasks.firebaseio.com/users"),i=f.authClient(),c=o.$defer("taskCards"),d=o.$defer("trelloAccount"),i.$on("unauthenticated",function(t,n){return o.lastAuthenticationError=n,o.authenticationState="unauthenticated",o.$emit("unauthenticated")}),l=null,s=null,i.$on("authenticated",function(t,n){return l||(l=f.child(""+n.id+"/tasks",[]),s=f.child(""+n.id+"/trelloAccount",{})),l.watch(),s.watch(),o.user=n,c.resolve(l.$get("value")),d.resolve(s.$get("value")),l.$attachProperty("value").to(o,"taskCards"),s.$attachProperty("value").to(o,"trelloAccount"),o.authenticationState="authenticated",o.$emit("authenticated")}),o.logout=function(){return l.stopWatching(),s.stopWatching(),i.logout()},o.login=function(t){return o.authenticationState="authenticating",i.login("password",{email:t.email,password:t.password})},o.createUser=function(t){return i.createUser(t.email,t.password).then(function(){return o.login(t)},function(t){return o.$apply(function(){return o.lastAuthenticationError=t})})},o}]),angular.module("TrelloTasksApp").factory("TrelloTasks",["$timeout","$rootScope","$serviceScope","Trello","Tasks",function(t,n,e,r,a){var u,o;return u=e(),u.authenticationState="unknown",u.lastAuthenticationError=a.lastAuthenticationError,o=function(){var t,n;return u.user=a.user,n={unknown:"unknown",authenticating:"authenticating",unauthenticated:"unauthenticated",authenticated:{unknown:"authenticating",authenticating:"authenticating",unauthenticated:"needTrello",authenticated:"authenticated"}},t=n[a.authenticationState],u.authenticationState=_.isObject(t)?t[r.authenticationState]:t,console.log("New state is "+u.authenticationState)},r.$on("unauthenticated",o),a.$on("unauthenticated",o),r.$on("authenticated",o),a.$on("authenticated",o),r.$on("authenticated",function(){return a.$evalAsync(function(){return a.trelloAccount.apiToken=r.getApiToken()})}),a.$on("authenticated",function(){return a.$get("trelloAccount").then(function(){var t;return t=a.trelloAccount.apiToken,t?r.authorize(t):r.authenticationState="unauthenticated",o()}),o()}),o(),a.$attachProperty("taskCards").to(u,"taskCards"),r.$on("cards-updated",function(t,n){return a.$get("taskCards").then(function(){var t,e;return t={},_.each(n,function(n){var e;return e=_.findWhere(u.taskCards,{id:n.id}),e?(angular.copy(n,e),t[e.id]=!0):void 0}),e=_.filter(u.taskCards,function(n){return t[n.id]}),u.$update("taskCards",e)})}),a.$get("taskCards").then(function(){return u.inTaskList=function(t){return!!_.findWhere(a.taskCards,{id:t.id})}}),u.createUser=function(t,n){return u.creatingUser=!0,a.createUser({email:t,password:n}).then(function(){return u.creatingUser=!1},function(){return u.creatingUser=!1})},u.signIn=function(t,n){return u.authenticating=!0,a.login({email:t,password:n})},u.signOut=function(){return a.logout()},u.connectTrello=function(){return r.authorize()},u}])}.call(this),function(){var t=[].slice;angular.module("TrelloTasksApp").factory("makeEventEmitter",["$rootScope","$timeout",function(n,e){return function(n){var r;return r={},n.on=function(t,n){var e;return null==(e=r[t])&&(r[t]=[]),r[t].push(n)},n.trigger=function(){var n,a;return a=arguments[0],n=arguments.length>=2?t.call(arguments,1):[],angular.forEach(r[a]||[],function(t){return e(function(){return t.apply(null,n)})})},n}}]),angular.module("TrelloTasksApp").factory("Trello",["$timeout","$cleanQ","$serviceScope","makeEventEmitter",function(n,e,r){var a,u,o,i,c,l;return a=r("trello"),a.authenticationState="unknown",o=function(){var n,r,u,o,i;return o=arguments[0],n=arguments.length>=2?t.call(arguments,1):[],u={},i=!0,_.isObject(n[0])?(u=n[0],i=n[1]===!1?!1:!0):i=n[0]===!1?!1:!0,r=e.defer(),Trello.get(o,u,function(t){return i?a.$apply(function(){return r.resolve(t)}):r.resolve(t)},function(t){return i?a.$apply(function(){return r.reject(t)}):r.reject(t)}),r.promise},a.authorize=function(t){var n;return t&&Trello.setToken(t),n=e.defer(),a.authenticationState="authenticating",setTimeout(function(){return Trello.authorize({name:"Taskello",type:"popup",interactive:!t,persist:!1,success:function(){return a.$apply(function(){return a.authenticationState="authenticated",a.$emit("authenticated"),n.resolve(!0)})},error:function(){return a.$apply(function(){return a.authenticationState="unauthenticated",a.$emit("unauthenticated"),n.reject(!0)})}})},0),n.promise},a.getApiToken=function(){return Trello.token()},a.me={},a.organizations={my:{displayName:"My Boards"}},a.boards={},a.lists={},a.cards={},u=!0,i=function(){var t,n,r,i,c,l;return a.synchronizing=!0,l=!1,u?(c=a.organizations,t=a.boards,n=a.cards,r=a.lists,i=a.me,u=!1,l=!0):(c={my:{displayName:"My Boards"}},t={},n={},r={},i={}),e.all([o("member/me/boards",{lists:"open"},l),o("member/me/organizations",l),o("member/me",l)]).then(function(a){var u,s,d;return u=a[0],d=a[1],s=a[2],angular.copy(s,i),_.each(d,function(t){return c[t.id]=t}),e.all(_.map(u,function(e){var a,u;return e.idOrganization&&c[e.idOrganization]||(e.idOrganization="my"),null==(u=(a=c[e.idOrganization]).boards)&&(a.boards=[]),c[e.idOrganization].boards.push(e),t[e.id]=e,_.each(e.lists,function(t){return r[t.id]=t}),o("board/"+e.id+"/cards",l).then(function(t){return e.cards=t,_.each(t,function(t){var e,a;return null==(a=(e=r[t.idList]).cards)&&(e.cards=[]),r[t.idList].cards.push(t),n[t.id]=t})})}))}).then(function(){return a.$apply(function(){return a.synchronizing=!1,a.$update("organizations",c),a.$update("boards",t),a.$update("cards",n),a.$update("lists",r),a.$update("me",i)}),a.$emit("cards-updated",a.cards),a.$emit("lists-updated",a.lists),a.$emit("boards-updated",a.boards),a.$emit("organizations-updated",a.organizations)})},l=null,c=function(){return i().then(function(){return l=n(c,3e4)})},a.$on("authenticated",c),a.$on("unauthenticated",function(){return null!=l?l.cancel():void 0}),a}])}.call(this);