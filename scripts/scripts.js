"use strict";angular.module("TrelloTasksApp",["ui.bootstrap"]).config(["$routeProvider",function(n){n.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),function(){angular.module("TrelloTasksApp").directive("fillParentHeight",["$timeout",function(n){return function(t,r){var e;return e=function(){var n,t,e;return e=r.parent().offset(),n=r.offset(),t=r.parent().height(),r.css({"max-height":t-(n.top-e.top)})},r.parent().on("resized",e),n(e)}}]),angular.module("TrelloTasksApp").directive("fillWindowHeight",["$timeout",function(n){return function(t,r){var e,a;return e=function(){var n,t,e;return t=r.offset(),e=$(window).height(),n=parseInt(r.css("marginBottom")),r.css({height:e-t.top-n}),r.trigger("resized")},a=function(){return e(),n(a,1e3)},a(),$(window).on("resize",e)}}]),angular.module("TrelloTasksApp").directive("throttledModel",[function(){return function(n,t,r){var e;return e=_.debounce(function(t){return n.$apply(function(){return n[r.throttledModel]=t})},50),t.on("input",function(){return e(t.val())})}}]),angular.module("TrelloTasksApp").controller("MainCtrl",["$scope","$q","Trello","TrelloTasks",function(n,t,r,e){var a,i;return n.trelloTasks=e,n.isBoardCollapsed=!1,n.isOrganizationCollapsed=!1,n.organizations=r.organizations,n.lists=r.lists,n.boards=r.boards,n.organizationHasMatchingCards=function(t,r){return _.any(t.boards,function(t){return n.boardHasMatchingCards(t,r)})},a=function(n,t){return t&&""!==t&&t.split?_.every(_.toArray(t.split(/\ /g)),function(t){var e,a;return a=RegExp(""+t,"i"),n.name.match(a)?!0:r.lists[n.idList].name.match(a)?!0:r.boards[n.idBoard].name.match(a)?!0:(e=r.boards[n.idBoard].idOrganization||"my",r.organizations[e].displayName.match(a)?!0:!1)}):!0},i=function(n,t){return _.any(n,function(n){return a(n,t)})},n.boardHasMatchingCards=function(n,t){return i(n.cards,t)},n.listHasMatchingCards=function(n,t){return i(n.cards,t)},n.cardMatches=a}])}.call(this),function(){angular.module("TrelloTasksApp").directive("sortable",[function(){return{require:"?ngModel",link:function(n,t,r,e){var a,i;return i=angular.extend({},n.$eval(r.sortable)),e.$render=function(){return t.sortable("refresh")},a=!1,t.sortable(i).on("sortstart",function(n,t){var r;return t.item.model||(r=$(t.helper).data("model"),r&&(t.item.model=r,t.item.fromElsewhere=!0)),t.item.model?void 0:t.item.model=e.$modelValue[t.item.index()]}).on("sortstop",function(t,r){var a,i,o;if(o=$(r.item).data("dropped"),r.item.model)if(a=_.indexOf(e.$modelValue,r.item.model),i=r.item.index(),o)e.$modelValue.splice(a,1);else{if(a===i)return;-1!==a&&e.$modelValue.splice(a,1),e.$modelValue.splice(i,0,r.item.model)}return $(r.item).remove(),n.$apply()})}}}]),angular.module("TrelloTasksApp").directive("draggable",[function(){return{require:"?ngModel",link:function(n,t,r,e){var a;return a=angular.extend({},n.$eval(r.draggable)),t.draggable(a).on("dragstart",function(n,t){return $(t.helper).data("model",e.$modelValue)})}}}]),angular.module("TrelloTasksApp").directive("droppable",[function(){return{link:function(n,t,r){var e;return e=angular.extend({},n.$eval(r.droppable)),t.droppable(e).on("drop",function(n,t){return $(t.draggable).data("dropped",!0)})}}}])}.call(this),function(){var n=[].slice;angular.module("TrelloTasksApp").factory("angularBurn",["$rootScope","$q","$timeout",function(t,r,e){var a,i;return a=function(i,o){var u,l,c,s,d,f,g,p;return null==o&&(o=[]),l=r.defer(),u=l.promise,p=null,c=null,s=null,g=function(n){return p||(p=angular.copy(o),l.resolve(p)),n.val()&&angular.copy(n.val(),p),c=angular.copy(p)},d=function(){var n;return i.on("value",function(n){return e(function(){return g(n)})}),n=!0,s=t.$watch(function(){var t;return n?(n=!1,void 0):(t=JSON.parse(angular.toJson(p)),angular.equals(c,t)?void 0:i.set(t))})},f=function(){return"function"==typeof s&&s(),i.off("value")},angular.extend(u,{_reference:i,authClient:function(r){return new FirebaseAuthClient(i,function(){var e;return e=arguments.length>=1?n.call(arguments,0):[],t.$eval(function(){return r.apply(null,e)})})},child:function(n,t){var r;return r=i.child(n),a(r,t)},watch:d,stopWatching:f}),u},i={},i.client=function(n,t){var r;return r=new Firebase(n),a(r,t)},i}])}.call(this),function(){angular.module("TrelloTasksApp").factory("Tasks",["$window","$rootScope","$timeout","$q","makeEventEmitter","angularBurn",function(n,t,r,e,a,i){var o,u,l,c,s,d,f;return c=a({}),l=e.defer(),f=e.defer(),c.user=null,c.authenticationState="unknown",c.lastAuthenticationError={},u=i.client("https://trellotasks.firebaseio.com/users"),o=u.authClient(function(n,t){return t?(c.user=t,c.authenticationState="authenticated",angular.copy({},c.lastAuthenticationError),c.trigger("authenticated")):(c.user=null,c.authenticationState="unauthenticated",angular.copy(n,c.lastAuthenticationError),c.trigger("unauthenticated",n))}),s=null,d=null,c.on("authenticated",function(){return s||(s=u.child(""+c.user.id+"/tasks",[]),l.resolve(s),d=u.child(""+c.user.id+"/trelloAccount",{}),f.resolve(d)),s.watch(),d.watch()}),c.on("unauthenticated",function(){return null!=s&&s.stopWatching(),null!=d?d.stopWatching():void 0}),c.getTaskCards=function(){return l.promise},c.getTrelloToken=function(){return f.promise.then(function(n){return n.apiToken})},c.setTrelloToken=function(n){return f.promise.then(function(t){return t.apiToken=n})},c.logout=function(){return null!=s&&s.stopWatching(),null!=d&&d.stopWatching(),o.logout()},c.login=function(n){return o.login("password",{email:n.email,password:n.password})},c.createUser=function(n){var r;return r=e.defer(),o.createUser(n.email,n.password,function(e){return e?(r.reject(),t.$apply(function(){return angular.copy(e,c.lastAuthenticationError)})):(c.login(n),r.resolve())}),r.promise},c}]),angular.module("TrelloTasksApp").factory("TrelloTasks",["$timeout","$rootScope","makeEventEmitter","Trello","Tasks",function(n,t,r,e,a){var i,o;return i=r({}),i.authenticationState="unknown",i.lastAuthenticationError=a.lastAuthenticationError,o=function(){return i.user=a.user,i.authenticationState="unknown"===a.authenticationState?"unknown":"authenticated"!==a.authenticationState?i.authenticating?"authenticating":"unauthenticated":e.authorized?"authenticated":i.authenticating?"authenticating":"needTrello"},e.on("unauthenticated",o),a.on("unauthenticated",o),e.on("authenticated",function(){return a.setTrelloToken(e.getApiToken()),o()}),a.on("authenticated",function(){return i.authenticating=!0,a.getTrelloToken().then(function(n){return n?(i.authenticating=!0,e.authorize(n).then(function(){return i.authenticating=!1},function(){return i.authenticating=!1})):i.authenticating=!1,o()}),o()}),o(),i.taskCards=a.getTaskCards(),e.on("cards-updated",function(n){return i.taskCards.then(function(t){var r,e;return r={},_.each(n,function(n){var e;return e=_.findWhere(t,{id:n.id}),e?(angular.copy(n,e),r[e.id]=!0):void 0}),e=_.filter(t,function(n){return r[n.id]}),angular.copy(e,t)})}),i.taskCards.then(function(n){return i.inTaskList=function(t){return!!_.findWhere(n,{id:t.id})}}),i.createUser=function(n,t){return i.creatingUser=!0,a.createUser({email:n,password:t}).then(function(){return i.creatingUser=!1},function(){return i.creatingUser=!1})},i.signIn=function(n,t){return i.authenticating=!0,a.login({email:n,password:t})},i.signOut=function(){return a.logout()},i.connectTrello=function(){return e.authorize()},i}])}.call(this),function(){var n=[].slice;angular.module("TrelloTasksApp").factory("makeEventEmitter",["$rootScope","$timeout",function(t,r){return function(t){var e;return e={},t.on=function(n,t){var r;return null==(r=e[n])&&(e[n]=[]),e[n].push(t)},t.trigger=function(){var t,a;return a=arguments[0],t=arguments.length>=2?n.call(arguments,1):[],angular.forEach(e[a]||[],function(n){return r(function(){return n.apply(null,t)})})},t}}]),angular.module("TrelloTasksApp").factory("Trello",["$rootScope","$timeout","$q","makeEventEmitter",function(n,t,r,e){var a,i,o,u,l,c,s;return s=e({}),s.authorized=!1,i=function(t,e){var a;return null==e&&(e={}),a=r.defer(),Trello.get(t,e,function(t){return n.$apply(function(){return a.resolve(t)})},function(t){return n.$apply(function(){return a.reject(t)})}),a.promise},s.authorize=function(n){var e;return n&&Trello.setToken(n),e=r.defer(),Trello.authorize({name:"Taskello",type:"popup",interactive:!n,persist:!1,success:function(){return t(function(){return s.authorized=!0,s.trigger("authenticated"),e.resolve(!0)})},error:function(){return t(function(){return s.trigger("unauthenticated"),e.reject(!0)})}}),e.promise},s.getApiToken=function(){return Trello.token()},s.organizations={my:{displayName:"My Boards"}},s.boards={},s.lists={},s.cards={},o=function(n,t){return n===t?t:(angular.forEach(n,function(n,r){return"$"!==("function"==typeof r.charAt?r.charAt(0):void 0)?_.isObject(n)&&_.isObject(t[r])||_.isArray(n)&&_.isArray(t[r])?o(n,t[r]):t[r]!==n?t[r]=n:void 0:void 0}),_.isArray(t)&&_.isArray(n)?t.length=n.length:angular.forEach(t,function(r,e){return"$"!==("function"==typeof e.charAt?e.charAt(0):void 0)?_.isUndefined(n[e])?delete t[e]:void 0:void 0}),t)},a=!0,u=function(){var n,t,e,u;return a?(u=s.organizations,n=s.boards,t=s.cards,e=s.lists,a=!1):(u={my:{displayName:"My Boards"}},n={},t={},e={}),r.all([i("member/me/boards",{lists:"open"}),i("member/me/organizations")]).then(function(a){var o,l;return o=a[0],l=a[1],_.each(l,function(n){return u[n.id]=n}),r.all(_.map(o,function(r){var a,o;return r.idOrganization&&u[r.idOrganization]||(r.idOrganization="my"),null==(o=(a=u[r.idOrganization]).boards)&&(a.boards=[]),u[r.idOrganization].boards.push(r),n[r.id]=r,_.each(r.lists,function(n){return e[n.id]=n}),i("board/"+r.id+"/cards").then(function(n){return r.cards=n,_.each(n,function(n){var r,a;return null==(a=(r=e[n.idList]).cards)&&(r.cards=[]),e[n.idList].cards.push(n),t[n.id]=n})})}))}).then(function(){return o(u,s.organizations),o(n,s.boards),o(t,s.cards),o(e,s.lists),s.trigger("cards-updated",s.cards),s.trigger("lists-updated",s.lists),s.trigger("boards-updated",s.boards),s.trigger("organizations-updated",s.organizations)})},c=null,l=function(){return u().then(function(){return c=t(l,1e4)})},s.on("authenticated",l),s.on("unauthenticated",function(){return null!=c?c.cancel():void 0}),s}])}.call(this);