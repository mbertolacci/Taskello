"use strict";angular.module("TrelloTasksApp",["ui.bootstrap","serviceUtilities"]).config(["$routeProvider",function(t){t.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),function(){angular.module("TrelloTasksApp").directive("fillParentHeight",["$timeout",function(){return function(t,n){var e;return e=function(){var t,e,r;return r=n.parent().offset(),t=n.offset(),e=n.parent().height(),n.css({"max-height":e-(t.top-r.top)})},n.parent().on("resized",e),setTimeout(e)}}]),angular.module("TrelloTasksApp").directive("fillWindowHeight",["$timeout",function(){return function(t,n){var e,r;return e=function(){var t,e,r;return e=n.offset(),r=$(window).height(),t=parseInt(n.css("marginBottom")),n.css({height:r-e.top-t}),n.trigger("resized")},r=function(){return e(),setTimeout(r,1e3)},r(),$(window).on("resize",e)}}]),angular.module("TrelloTasksApp").directive("throttledModel",[function(){return function(t,n,e){var r;return r=_.debounce(function(n){return t.$apply(function(){return t[e.throttledModel]=n})},50),n.on("input",function(){return r(n.val())})}}]),angular.module("TrelloTasksApp").controller("MainCtrl",["$scope","$q","Trello","TrelloTasks",function(t,n,e,r){var a,i;return t.trelloTasks=r,t.isBoardCollapsed=!1,t.isOrganizationCollapsed=!1,t.$name="main",t.trello=e.$attach(t,"trello"),t.organizationHasMatchingCards=function(n,e){return _.any(n.boards,function(n){return t.boardHasMatchingCards(n,e)})},a=function(t,n){var r;return n.justMe&&-1===_.indexOf(t.idMembers,e.me.id)?!1:(r=n.searchTerms,r&&""!==r&&r.split?_.every(_.toArray(r.split(/\ /g)),function(n){var r,a;return a=RegExp(""+n,"i"),t.name.match(a)?!0:e.lists[t.idList].name.match(a)?!0:e.boards[t.idBoard].name.match(a)?!0:(r=e.boards[t.idBoard].idOrganization||"my",e.organizations[r].displayName.match(a)?!0:!1)}):!0)},i=function(t,n){return _.any(t,function(t){return a(t,n)})},t.boardHasMatchingCards=function(t,n){return i(t.cards,n)},t.listHasMatchingCards=function(t,n){return i(t.cards,n)},t.cardMatches=a}])}.call(this),function(){angular.module("TrelloTasksApp").directive("sortable",[function(){return{require:"?ngModel",link:function(t,n,e,r){var a,i;return i=angular.extend({},t.$eval(e.sortable)),r.$render=function(){return n.sortable("refresh")},a=!1,n.sortable(i).on("sortstart",function(t,n){var e;return n.item.model||(e=$(n.helper).data("model"),e&&(n.item.model=e,n.item.fromElsewhere=!0)),n.item.model?void 0:n.item.model=r.$modelValue[n.item.index()]}).on("sortstop",function(n,e){var a,i,u;if(u=$(e.item).data("dropped"),e.item.model)if(a=_.indexOf(r.$modelValue,e.item.model),i=e.item.index(),u)r.$modelValue.splice(a,1);else{if(a===i)return;-1!==a&&r.$modelValue.splice(a,1),r.$modelValue.splice(i,0,e.item.model)}return $(e.item).remove(),t.$apply()})}}}]),angular.module("TrelloTasksApp").directive("draggable",[function(){return{require:"?ngModel",link:function(t,n,e,r){var a;return a=angular.extend({},t.$eval(e.draggable)),n.draggable(a).on("dragstart",function(t,n){return $(n.helper).data("model",r.$modelValue)})}}}]),angular.module("TrelloTasksApp").directive("droppable",[function(){return{link:function(t,n,e){var r;return r=angular.extend({},t.$eval(e.droppable)),n.droppable(r).on("drop",function(t,n){return $(n.draggable).data("dropped",!0)})}}}])}.call(this),function(){var t,n=[].slice;t=function(t){return setTimeout(t,0)},angular.module("TrelloTasksApp").factory("angularBurn",["$q","$serviceScope",function(e,r){var a,i,u;return a=function(a){var i,u;return i=r(),u=new FirebaseAuthClient(a,function(n,e){return t(function(){return i.$apply(function(){return e?i.$emit("authenticated",e):i.$emit("unauthenticated",n)})})}),i.login=function(){var t;return t=arguments.length>=1?n.call(arguments,0):[],u.login.apply(u,t)},i.logout=function(){var t;return t=arguments.length>=1?n.call(arguments,0):[],u.logout.apply(u,t)},i.createUser=function(){var t,r;return t=arguments.length>=1?n.call(arguments,0):[],r=e.defer(),u.createUser.apply(u,n.call(t).concat([function(t,n){return t?r.reject(t):r.resolve(n)}])),r.promise},i},i=function(t,n){var e,u,o,l,c,s,d,f;return null==n&&(n=[]),u=r(),f=u.$defer("value"),o=null,e=function(t){return setTimeout(function(){return u.$apply(t)},0)},d=function(t){return u.value||(u.value=angular.copy(n),f.resolve(u.value)),angular.copy(t.val(),u.value),o=angular.copy(u.value)},l=null,c=function(){var n;return t.on("value",function(t){return e(function(){return d(t)})}),n=!0,l=u.$watch(function(){var e;return n?(n=!1,void 0):_.isUndefined(u.value)?void 0:(e=JSON.parse(angular.toJson(u.value)),angular.equals(o,e)?void 0:t.set(e))})},s=function(){return"function"==typeof l&&l(),t.off("value")},angular.extend(u,{_reference:t,authClient:function(){return a(t)},child:function(n,e){var r;return r=t.child(n),i(r,e)},watch:c,stopWatching:s}),u},u={},u.client=function(t,n){var e;return e=new Firebase(t),i(e,n)},u}])}.call(this),function(){angular.module("TrelloTasksApp").factory("Tasks",["$window","$rootScope","$timeout","$serviceScope","angularBurn",function(t,n,e,r,a){var i,u,o,l,c,s,d;return i=r(),i.user=null,i.authenticationState="unknown",i.lastAuthenticationError={},i.taskCards=null,i.trelloApiToken=null,d=a.client("https://trellotasks.firebaseio.com/users"),u=d.authClient(),o=i.$defer("taskCards"),s=i.$defer("trelloAccount"),u.$on("unauthenticated",function(t,n){return i.lastAuthenticationError=n,i.authenticationState="unauthenticated",i.$emit("unauthenticated")}),l=null,c=null,u.$on("authenticated",function(t,n){return l||(l=d.child(""+n.id+"/tasks",[]),c=d.child(""+n.id+"/trelloAccount",{})),l.watch(),c.watch(),i.user=n,o.resolve(l.$get("value")),s.resolve(c.$get("value")),l.$attachProperty("value",i,"taskCards"),c.$attachProperty("value",i,"trelloAccount"),i.authenticationState="authenticated",i.$emit("authenticated")}),i.logout=function(){return l.stopWatching(),c.stopWatching(),u.logout()},i.login=function(t){return i.authenticationState="authenticating",u.login("password",{email:t.email,password:t.password})},i.createUser=function(t){return u.createUser(t.email,t.password).then(function(){return i.login(t)},function(t){return i.$apply(function(){return i.lastAuthenticationError=t})})},i}]),angular.module("TrelloTasksApp").factory("TrelloTasks",["$timeout","$rootScope","$serviceScope","Trello","Tasks",function(t,n,e,r,a){var i,u;return i=e(),i.authenticationState="unknown",i.lastAuthenticationError=a.lastAuthenticationError,u=function(){var t,n;return i.user=a.user,n={unknown:"unknown",authenticating:"authenticating",unauthenticated:"unauthenticated",authenticated:{unknown:"authenticating",authenticating:"authenticating",unauthenticated:"needTrello",authenticated:"authenticated"}},t=n[a.authenticationState],i.authenticationState=_.isObject(t)?t[r.authenticationState]:t,console.log("New state is "+i.authenticationState)},r.$on("unauthenticated",u),a.$on("unauthenticated",u),r.$on("authenticated",u),a.$on("authenticated",u),r.$on("authenticated",function(){return a.$evalAsync(function(){return a.trelloAccount.apiToken=r.getApiToken()})}),a.$on("authenticated",function(){return a.$get("trelloAccount").then(function(){var t;return t=a.trelloAccount.apiToken,t?r.authorize(t):r.authenticationState="unauthenticated",u()}),u()}),u(),a.$attachProperty("taskCards",i,"taskCards"),r.$on("cards-updated",function(t,n){return a.$get("taskCards").then(function(){var t,e;return t={},_.each(n,function(n){var e;return e=_.findWhere(i.taskCards,{id:n.id}),e?(angular.copy(n,e),t[e.id]=!0):void 0}),e=_.filter(i.taskCards,function(n){return t[n.id]}),i.$update("taskCards",e)})}),a.$get("taskCards").then(function(){return i.inTaskList=function(t){return!!_.findWhere(a.taskCards,{id:t.id})}}),i.createUser=function(t,n){return i.creatingUser=!0,a.createUser({email:t,password:n}).then(function(){return i.creatingUser=!1},function(){return i.creatingUser=!1})},i.signIn=function(t,n){return i.authenticating=!0,a.login({email:t,password:n})},i.signOut=function(){return a.logout()},i.connectTrello=function(){return r.authorize()},i}])}.call(this),function(){var t=[].slice;angular.module("TrelloTasksApp").factory("makeEventEmitter",["$rootScope","$timeout",function(n,e){return function(n){var r;return r={},n.on=function(t,n){var e;return null==(e=r[t])&&(r[t]=[]),r[t].push(n)},n.trigger=function(){var n,a;return a=arguments[0],n=arguments.length>=2?t.call(arguments,1):[],angular.forEach(r[a]||[],function(t){return e(function(){return t.apply(null,n)})})},n}}]),angular.module("TrelloTasksApp").factory("Trello",["$timeout","$serviceQ","$serviceScope","makeEventEmitter",function(n,e,r){var a,i,u,o,l,c;return a=r("trello"),a.authenticationState="unknown",u=function(){var n,r,i,u,o;return u=arguments[0],n=arguments.length>=2?t.call(arguments,1):[],i={},o=!0,_.isObject(n[0])?(i=n[0],o=n[1]===!1?!1:!0):o=n[0]===!1?!1:!0,r=e.defer(),Trello.get(u,i,function(t){return o?a.$apply(function(){return r.resolve(t)}):r.resolve(t)},function(t){return o?a.$apply(function(){return r.reject(t)}):r.reject(t)}),r.promise},a.authorize=function(t){var n;return t&&Trello.setToken(t),n=e.defer(),a.authenticationState="authenticating",setTimeout(function(){return Trello.authorize({name:"Taskello",type:"popup",interactive:!t,persist:!1,success:function(){return a.$apply(function(){return a.authenticationState="authenticated",a.$emit("authenticated"),n.resolve(!0)})},error:function(){return a.$apply(function(){return a.authenticationState="unauthenticated",a.$emit("unauthenticated"),n.reject(!0)})}})},0),n.promise},a.getApiToken=function(){return Trello.token()},a.me={},a.organizations={my:{displayName:"My Boards"}},a.boards={},a.lists={},a.cards={},i=!0,o=function(){var t,n,r,o,l,c;return a.synchronizing=!0,c=!1,i?(l=a.organizations,t=a.boards,n=a.cards,r=a.lists,o=a.me,i=!1,c=!0):(l={my:{displayName:"My Boards"}},t={},n={},r={},o={}),e.all([u("member/me/boards",{lists:"open"},c),u("member/me/organizations",c),u("member/me",c)]).then(function(a){var i,s,d;return i=a[0],d=a[1],s=a[2],angular.copy(s,o),_.each(d,function(t){return l[t.id]=t}),e.all(_.map(i,function(e){var a,i;return e.idOrganization&&l[e.idOrganization]||(e.idOrganization="my"),null==(i=(a=l[e.idOrganization]).boards)&&(a.boards=[]),l[e.idOrganization].boards.push(e),t[e.id]=e,_.each(e.lists,function(t){return r[t.id]=t}),u("board/"+e.id+"/cards",c).then(function(t){return e.cards=t,_.each(t,function(t){var e,a;return null==(a=(e=r[t.idList]).cards)&&(e.cards=[]),r[t.idList].cards.push(t),n[t.id]=t})})}))}).then(function(){return a.$apply(function(){return a.synchronizing=!1,a.$update("organizations",l),a.$update("boards",t),a.$update("cards",n),a.$update("lists",r),a.$update("me",o)}),a.$emit("cards-updated",a.cards),a.$emit("lists-updated",a.lists),a.$emit("boards-updated",a.boards),a.$emit("organizations-updated",a.organizations)})},c=null,l=function(){return o().then(function(){return c=n(l,3e4)})},a.$on("authenticated",l),a.$on("unauthenticated",function(){return null!=c?c.cancel():void 0}),a}])}.call(this);