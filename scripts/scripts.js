"use strict";angular.module("TrelloTasksApp",["ui.bootstrap","serviceUtilities"]).config(["$routeProvider",function(t){t.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),function(){angular.module("TrelloTasksApp").directive("fillParentHeight",["$timeout",function(){return function(t,e){var n;return n=function(){var t,n,r;return r=e.parent().offset(),t=e.offset(),n=e.parent().height(),e.css({"max-height":n-(t.top-r.top)})},e.parent().on("resized",n),setTimeout(n)}}]),angular.module("TrelloTasksApp").directive("fillWindowHeight",["$timeout",function(){return function(t,e){var n,r;return n=function(){var t,n,r;return n=e.offset(),r=$(window).height(),t=parseInt(e.css("marginBottom")),e.css({height:r-n.top-t}),e.trigger("resized")},r=function(){return n(),setTimeout(r,1e3)},r(),$(window).on("resize",n)}}]),angular.module("TrelloTasksApp").directive("throttledModel",[function(){return function(t,e,n){var r;return r=_.debounce(function(e){return t.$apply(function(){return t[n.throttledModel]=e})},50),e.on("input",function(){return r(e.val())})}}]),angular.module("TrelloTasksApp").controller("MainCtrl",["$scope","$q","Trello","TrelloTasks",function(t,e,n,r){var a,i;return t.trelloTasks=r.$attach(t,"trelloTasks"),t.isBoardCollapsed=!1,t.isOrganizationCollapsed=!1,t.$name="main",t.trello=n.$attach(t,"trello"),t.organizationHasMatchingCards=function(e,n){return _.any(e.boards,function(e){return t.boardHasMatchingCards(e,n)})},a=function(t,e){var r;return e.justMe&&-1===_.indexOf(t.idMembers,n.me.id)?!1:(r=e.searchTerms,r&&""!==r&&r.split?_.every(_.toArray(r.split(/\ /g)),function(e){var r,a;return a=RegExp(""+e,"i"),t.name.match(a)?!0:n.lists[t.idList].name.match(a)?!0:n.boards[t.idBoard].name.match(a)?!0:(r=n.boards[t.idBoard].idOrganization||"my",n.organizations[r].displayName.match(a)?!0:!1)}):!0)},i=function(t,e){return _.any(t,function(t){return a(t,e)})},t.boardHasMatchingCards=function(t,e){return i(t.cards,e)},t.listHasMatchingCards=function(t,e){return i(t.cards,e)},t.cardMatches=a}])}.call(this),function(){angular.module("TrelloTasksApp").directive("sortable",[function(){return{require:"?ngModel",link:function(t,e,n,r){var a,i;return i=angular.extend({},t.$eval(n.sortable)),r.$render=function(){return e.sortable("refresh")},a=!1,e.sortable(i).on("sortstart",function(t,e){var n;return e.item.model||(n=$(e.helper).data("model"),n&&(e.item.model=n,e.item.fromElsewhere=!0)),e.item.model?void 0:e.item.model=r.$modelValue[e.item.index()]}).on("sortstop",function(e,n){var a,i,u;if(u=$(n.item).data("dropped"),n.item.model)if(a=_.indexOf(r.$modelValue,n.item.model),i=n.item.index(),u)r.$modelValue.splice(a,1);else{if(a===i)return;-1!==a&&r.$modelValue.splice(a,1),r.$modelValue.splice(i,0,n.item.model)}return $(n.item).remove(),t.$apply()})}}}]),angular.module("TrelloTasksApp").directive("draggable",[function(){return{require:"?ngModel",link:function(t,e,n,r){var a;return a=angular.extend({},t.$eval(n.draggable)),e.draggable(a).on("dragstart",function(t,e){return $(e.helper).data("model",r.$modelValue)})}}}]),angular.module("TrelloTasksApp").directive("droppable",[function(){return{link:function(t,e,n){var r;return r=angular.extend({},t.$eval(n.droppable)),e.droppable(r).on("drop",function(t,e){return $(e.draggable).data("dropped",!0)})}}}])}.call(this),function(){var t,e=[].slice;t=function(t){return setTimeout(t,0)},angular.module("TrelloTasksApp").factory("angularBurn",["$serviceQ","$serviceScope",function(n,r){var a,i,u;return a=function(a){var i,u;return i=r(),u=new FirebaseAuthClient(a,function(e,n){return t(function(){return i.$apply(function(){return n?i.$emit("authenticated",n):i.$emit("unauthenticated",e)})})}),i.login=function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],u.login.apply(u,t)},i.logout=function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],u.logout.apply(u,t)},i.createUser=function(t,e){var r;return r=n.defer(),u.createUser(t,e,function(t,e){return t?r.reject(t):r.resolve(e)}),r.promise},i},i=function(t,e){var n,u,o,l,c,s,d,f;return null==e&&(e=[]),u=r(),f=u.$defer("value"),o=null,n=function(t){return setTimeout(function(){return u.$apply(t)},0)},d=function(t){return u.value||(u.value=angular.copy(e),f.resolve(u.value)),angular.copy(t.val(),u.value),o=angular.copy(u.value)},l=null,c=function(){var e;return t.on("value",function(t){return n(function(){return d(t)})}),e=!0,l=u.$watch(function(){var n;return e?(e=!1,void 0):_.isUndefined(u.value)?void 0:(n=JSON.parse(angular.toJson(u.value)),angular.equals(o,n)?void 0:t.set(n))})},s=function(){return"function"==typeof l&&l(),t.off("value")},angular.extend(u,{_reference:t,authClient:function(){return a(t)},child:function(e,n){var r;return r=t.child(e),i(r,n)},watch:c,stopWatching:s}),u},u={},u.client=function(t,e){var n;return n=new Firebase(t),i(n,e)},u}])}.call(this),function(){angular.module("TrelloTasksApp").factory("Tasks",["$window","$rootScope","$timeout","$serviceScope","angularBurn",function(t,e,n,r,a){var i,u,o,l,c,s,d;return i=r(),i.user=null,i.authenticationState="unknown",i.lastAuthenticationError={},i.taskCards=null,i.trelloApiToken=null,d=a.client("https://trellotasks.firebaseio.com/users"),u=d.authClient(),o=i.$defer("taskCards"),s=i.$defer("trelloAccount"),u.$on("unauthenticated",function(t,e){return i.lastAuthenticationError=e,i.authenticationState="unauthenticated",i.$emit("unauthenticated")}),l=null,c=null,u.$on("authenticated",function(t,e){return l||(l=d.child(""+e.id+"/tasks",[]),c=d.child(""+e.id+"/trelloAccount",{})),l.watch(),c.watch(),i.user=e,o.resolve(l.$get("value")),s.resolve(c.$get("value")),l.$attachProperty("value",i,"taskCards"),c.$attachProperty("value",i,"trelloAccount"),i.authenticationState="authenticated",i.$emit("authenticated")}),i.logout=function(){return l.stopWatching(),c.stopWatching(),u.logout()},i.login=function(t){return i.authenticationState="authenticating",u.login("password",{email:t.email,password:t.password})},i.createUser=function(t){return u.createUser(t.email,t.password).then(function(){return i.login(t)},function(t){return i.$apply(function(){return i.lastAuthenticationError=t})})},i}]),angular.module("TrelloTasksApp").factory("TrelloTasks",["$timeout","$rootScope","$serviceScope","Trello","Tasks",function(t,e,n,r,a){var i,u;return i=n(),i.authenticationState="unknown",i.lastAuthenticationError=a.lastAuthenticationError,u=function(){var t,n;return e.$$phase?(i.user=a.user,n={unknown:"unknown",authenticating:"authenticating",unauthenticated:"unauthenticated",authenticated:{unknown:"authenticating",authenticating:"authenticating",unauthenticated:"needTrello",authenticated:"authenticated"}},t=n[a.authenticationState],i.authenticationState=_.isObject(t)?t[r.authenticationState]:t,console.log("New state is "+i.authenticationState)):(i.$apply(u),void 0)},r.$on("unauthenticated",u),a.$on("unauthenticated",u),r.$on("authenticated",u),a.$on("authenticated",u),r.$on("authenticated",function(){return a.$evalAsync(function(){return a.trelloAccount.apiToken=r.getApiToken()})}),a.$on("authenticated",function(){return a.$get("trelloAccount").then(function(){var t;return t=a.trelloAccount.apiToken,t?r.authorize(t):r.authenticationState="unauthenticated",u()}),u()}),u(),a.$attachProperty("taskCards",i,"taskCards"),r.$on("cards-updated",function(t,e){return a.$get("taskCards").then(function(){var t,n;return t={},_.each(e,function(e){var n;return n=_.findWhere(i.taskCards,{id:e.id}),n?(angular.copy(e,n),t[n.id]=!0):void 0}),n=_.filter(i.taskCards,function(e){return t[e.id]}),i.$update("taskCards",n)})}),a.$get("taskCards").then(function(){return i.inTaskList=function(t){return!!_.findWhere(a.taskCards,{id:t.id})}}),i.createUser=function(t,e){return i.creatingUser=!0,a.createUser({email:t,password:e}).then(function(){return i.creatingUser=!1},function(){return i.creatingUser=!1})},i.signIn=function(t,e){return i.authenticating=!0,a.login({email:t,password:e})},i.signOut=function(){return a.logout()},i.connectTrello=function(){return r.authorize()},i}])}.call(this),function(){var t=[].slice;angular.module("TrelloTasksApp").factory("makeEventEmitter",["$rootScope","$timeout",function(e,n){return function(e){var r;return r={},e.on=function(t,e){var n;return null==(n=r[t])&&(r[t]=[]),r[t].push(e)},e.trigger=function(){var e,a;return a=arguments[0],e=arguments.length>=2?t.call(arguments,1):[],angular.forEach(r[a]||[],function(t){return n(function(){return t.apply(null,e)})})},e}}]),angular.module("TrelloTasksApp").factory("Trello",["$timeout","$serviceQ","$serviceScope","makeEventEmitter",function(e,n,r){var a,i,u,o,l,c;return a=r("trello"),a.authenticationState="unknown",u=function(){var e,r,i,u,o;return u=arguments[0],e=arguments.length>=2?t.call(arguments,1):[],i={},o=!0,_.isObject(e[0])?(i=e[0],o=e[1]===!1?!1:!0):o=e[0]===!1?!1:!0,r=n.defer(),Trello.get(u,i,function(t){return o?a.$apply(function(){return r.resolve(t)}):r.resolve(t)},function(t){return 401===t.status&&a.$apply(function(){return Trello.deauthorize(),a.authenticationState="unauthenticated",a.$emit("unauthenticated")}),o?a.$apply(function(){return r.reject(t)}):r.reject(t)}),r.promise},a.authorize=function(t){var e;return t&&Trello.setToken(t),e=n.defer(),a.authenticationState="authenticating",setTimeout(function(){return Trello.authorize({name:"Taskello",type:"popup",interactive:!t,persist:!1,success:function(){return a.$apply(function(){return a.authenticationState="authenticated",a.$emit("authenticated"),e.resolve(!0)})},error:function(){return a.$apply(function(){return a.authenticationState="unauthenticated",a.$emit("unauthenticated"),e.reject(!0)})}})},0),e.promise},a.getApiToken=function(){return Trello.token()},a.me={},a.organizations={my:{displayName:"My Boards"}},a.boards={},a.lists={},a.cards={},i=!0,o=function(){var t,e,r,o,l,c;return a.synchronizing=!0,c=!1,i?(l=a.organizations,t=a.boards,e=a.cards,r=a.lists,o=a.me,i=!1,c=!0):(l={my:{displayName:"My Boards"}},t={},e={},r={},o={}),n.all([u("member/me/boards",{lists:"open"},c),u("member/me/organizations",c),u("member/me",c)]).then(function(a){var i,s,d;return i=a[0],d=a[1],s=a[2],angular.copy(s,o),_.each(d,function(t){return l[t.id]=t}),n.all(_.map(i,function(n){var a,i;return n.idOrganization&&l[n.idOrganization]||(n.idOrganization="my"),null==(i=(a=l[n.idOrganization]).boards)&&(a.boards=[]),l[n.idOrganization].boards.push(n),t[n.id]=n,_.each(n.lists,function(t){return r[t.id]=t}),u("board/"+n.id+"/cards",c).then(function(t){return n.cards=t,_.each(t,function(t){var n,a;return null==(a=(n=r[t.idList]).cards)&&(n.cards=[]),r[t.idList].cards.push(t),e[t.id]=t})})}))}).then(function(){return a.$apply(function(){return a.synchronizing=!1,a.$update("organizations",l),a.$update("boards",t),a.$update("cards",e),a.$update("lists",r),a.$update("me",o)}),a.$emit("cards-updated",a.cards),a.$emit("lists-updated",a.lists),a.$emit("boards-updated",a.boards),a.$emit("organizations-updated",a.organizations)})},c=null,l=function(){return o().then(function(){return c=e(l,3e4)})},a.$on("authenticated",l),a.$on("unauthenticated",function(){return null!=c?c.cancel():void 0}),a}])}.call(this);